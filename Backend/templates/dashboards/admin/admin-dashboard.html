<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Admin Portal - CCRSMS{% endblock %}</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#F3F4F6',
                        dark: '#1F2937',
                        accent: '#F59E0B',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #complaintsMap { 
            height: 420px; 
            border-radius: 14px; 
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>

<body class="bg-gray-100">
    <div class="flex">
        <!-- Sidebar -->
        <aside
            class="bg-gray-800 text-white shadow-xl h-screen flex flex-col sticky top-0 transition-all duration-300 w-64">
            <div class="p-6 border-b border-gray-700 flex items-center justify-between">
                <h2 class="text-xl font-bold flex items-center gap-2 whitespace-nowrap overflow-hidden">
                    <span class="bg-yellow-500 text-gray-900 p-1 rounded text-sm font-extrabold">AP</span>
                    Admin Portal
                </h2>
                <!-- Mobile Toggle would go here -->
            </div>

            <nav class="flex-1 p-3 space-y-2 overflow-y-auto overflow-x-hidden">
                <a href="{% url 'admin_dashboard' %}"
                    class="flex items-center gap-3 px-3 py-3 rounded-lg transition-colors font-medium whitespace-nowrap bg-blue-600 text-white shadow-md">
                    <i class="fas fa-tachometer-alt text-xl flex-shrink-0"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{% url 'admin_complaint_list' %}"
                    class="flex items-center gap-3 px-3 py-3 rounded-lg transition-colors font-medium whitespace-nowrap text-gray-400 hover:bg-gray-700 hover:text-white">
                    <i class="fas fa-clipboard-list text-xl flex-shrink-0"></i>
                    <span>Complaints</span>
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-3 rounded-lg transition-colors font-medium whitespace-nowrap text-gray-400 hover:bg-gray-700 hover:text-white">
                    <i class="fas fa-file-contract text-xl flex-shrink-0"></i>
                    <span>Permits</span>
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-3 rounded-lg transition-colors font-medium whitespace-nowrap text-gray-400 hover:bg-gray-700 hover:text-white">
                    <i class="fas fa-user-shield text-xl flex-shrink-0"></i>
                    <span>Assign Staff</span>
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-3 rounded-lg transition-colors font-medium whitespace-nowrap text-gray-400 hover:bg-gray-700 hover:text-white">
                    <i class="fas fa-users text-xl flex-shrink-0"></i>
                    <span>Users</span>
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-3 rounded-lg transition-colors font-medium whitespace-nowrap text-gray-400 hover:bg-gray-700 hover:text-white">
                    <i class="fas fa-chart-bar text-xl flex-shrink-0"></i>
                    <span>Analytics</span>
                </a>
                <a href="#"
                    class="flex items-center gap-3 px-3 py-3 rounded-lg transition-colors font-medium whitespace-nowrap text-gray-400 hover:bg-gray-700 hover:text-white">
                    <i class="fas fa-cog text-xl flex-shrink-0"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-700">
                <form action="{% url 'staff_logout' %}" method="post">
                    {% csrf_token %}
                    <button
                        class="flex items-center gap-3 px-3 py-3 w-full text-red-400 hover:bg-red-900/20 rounded-lg transition-colors font-medium whitespace-nowrap">
                        <i class="fas fa-sign-out-alt text-xl flex-shrink-0"></i>
                        <span>Logout</span>
                    </button>
                </form>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow bg-gray-100 min-h-screen p-8 overflow-y-auto h-screen">
            {% block content %}
                <div class="max-w-7xl mx-auto">
                <header class="mb-8 flex flex-col md:flex-row justify-between md:items-center gap-4">
                    <div>
                    <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                    <p class="text-gray-500">System-level overview, analytics, and map intelligence.</p>
                    </div>
                </header>

                <!-- KPIs -->
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex items-center p-6">
                    <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl mr-4 bg-blue-100 text-blue-600">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-500 text-sm font-medium">Total Complaints</p>
                        <h3 class="text-2xl font-bold text-gray-900">{{ admin_stats.total|default:0 }}</h3>
                    </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex items-center p-6">
                    <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl mr-4 bg-yellow-100 text-yellow-600">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-500 text-sm font-medium">Submitted</p>
                        <h3 class="text-2xl font-bold text-gray-900">{{ admin_stats.submitted|default:0 }}</h3>
                    </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex items-center p-6">
                    <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl mr-4 bg-purple-100 text-purple-600">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-500 text-sm font-medium">In Progress</p>
                        <h3 class="text-2xl font-bold text-gray-900">{{ admin_stats.in_progress|default:0 }}</h3>
                    </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex items-center p-6">
                    <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl mr-4 bg-green-100 text-green-600">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-500 text-sm font-medium">Resolved</p>
                        <h3 class="text-2xl font-bold text-gray-900">{{ admin_stats.resolved|default:0 }}</h3>
                    </div>
                    </div>
                </div>

                <!-- Map + Filters -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Complaints Intelligence Map</h3>
                        <p class="text-sm text-gray-500">Cluster, heatmap, and filters across wards/departments.</p>
                    </div>

                    <div class="flex flex-wrap items-center gap-2">
                        <label class="text-sm text-gray-600">View</label>
                        <select id="mapViewMode" class="border border-gray-300 px-3 py-2 rounded-lg text-sm bg-white">
                        <option value="cluster" selected>Cluster</option>
                        <option value="heat">Heatmap</option>
                        </select>

                        <label class="text-sm text-gray-600 ml-2">Color by</label>
                        <select id="colorMode" class="border border-gray-300 px-3 py-2 rounded-lg text-sm bg-white">
                        <option value="status" selected>Status</option>
                        <option value="priority">Priority</option>
                        </select>
                    </div>
                    </div>

                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
                    <!-- <input type="date" id="dateFrom" class="border border-gray-300 px-3 py-2 rounded-lg text-sm bg-white" />
                    <input type="date" id="dateTo" class="border border-gray-300 px-3 py-2 rounded-lg text-sm bg-white" /> -->

                    <select id="categoryFilter" class="border border-gray-300 px-3 py-2 rounded-lg text-sm bg-white">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.category_name }}</option>
                        {% endfor %}
                    </select>

                    <select id="statusFilter" class="border border-gray-300 px-3 py-2 rounded-lg text-sm bg-white">
                        <option value="">All Status</option>
                        <option value="SUBMITTED">Submitted</option>
                        <option value="ACKNOWLEDGED">Acknowledged</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="RESOLVED">Resolved</option>
                        <option value="REJECTED">Rejected</option>
                    </select>

                    <select id="wardFilter" class="border border-gray-300 px-3 py-2 rounded-lg text-sm bg-white">
                        <option value="">All Wards</option>
                        {% for w in wards %}
                        <option value="{{ w.id }}">{{ w.name }}</option>
                        {% endfor %}
                    </select>

                    <select id="departmentFilter" class="border border-gray-300 px-3 py-2 rounded-lg text-sm bg-white">
                        <option value="">All Departments</option>
                        {% for d in departments %}
                        <option value="{{ d.id }}">{{ d.name }}</option>
                        {% endfor %}
                    </select>
                    </div>

                    <div id="complaintsMap"></div>
                </div>

                <!-- Charts -->
                <div class="grid lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900">Complaints per Ward</h3>
                        <span class="text-xs text-gray-500">Top wards by volume</span>
                    </div>
                    <canvas id="wardChart"></canvas>
                    </div>

                    <div class="bg-white rounded-xl p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900">Complaints per Category</h3>
                        <span class="text-xs text-gray-500">Distribution</span>
                    </div>
                    <canvas id="categoryChart"></canvas>
                    </div>

                    <div class="bg-white rounded-xl p-6 border border-gray-100 lg:col-span-2">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900">Complaints per Day</h3>
                        <span class="text-xs text-gray-500">Trend line</span>
                    </div>
                    <canvas id="dayChart"></canvas>
                    </div>
                </div>

                {% if messages %}
                <div class="mb-6 space-y-2">
                    {% for message in messages %}
                    <div class="p-3 rounded-lg border
                        {% if message.tags == 'success' %} bg-green-50 border-green-200 text-green-700
                        {% elif message.tags == 'error' %} bg-red-50 border-red-200 text-red-700
                        {% else %} bg-gray-50 border-gray-200 text-gray-700 {% endif %}">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                </div>
                {% endblock %}
        </main>
    </div>
    <script>
        const DETAIL_BASE_URL = "/core/admin/complaints/";
        const GEOJSON_URL = "{% url 'admin_complaints_geojson' %}";

        const STATUS_COLORS = {
            "SUBMITTED": "#F59E0B",
            "ACKNOWLEDGED": "#3B82F6",
            "IN_PROGRESS": "#8B5CF6",
            "RESOLVED": "#22C55E",
            "REJECTED": "#EF4444",
        };
        const PRIORITY_COLORS = { "LOW": "#22C55E", "MEDIUM": "#F59E0B", "HIGH": "#EF4444" };
        const PRIORITY_INTENSITY = { "LOW": 0.3, "MEDIUM": 0.6, "HIGH": 1.0 };

        let map, clusterLayer, heatLayer;
        let currentColorMode = "status";
        let currentViewMode = "cluster";

        function getColor(p) {
            if (currentColorMode === "priority") return PRIORITY_COLORS[p.priority_level] || "#6B7280";
            return STATUS_COLORS[p.status] || "#6B7280";
        }

        function buildQuery() {
            const params = new URLSearchParams();
            const dateFrom = document.getElementById("dateFrom")?.value;
            const dateTo = document.getElementById("dateTo")?.value;
            const category = document.getElementById("categoryFilter")?.value;
            const status = document.getElementById("statusFilter")?.value;
            const ward = document.getElementById("wardFilter")?.value;
            const dept = document.getElementById("departmentFilter")?.value;

            if (dateFrom) params.set("date_from", dateFrom);
            if (dateTo) params.set("date_to", dateTo);
            if (category) params.set("category", category);
            if (status) params.set("status", status);
            if (ward) params.set("ward", ward);
            if (dept) params.set("department", dept);

            return params.toString() ? `?${params.toString()}` : "";
        }

        async function loadGeoJSON() {
            const res = await fetch(`${GEOJSON_URL}${buildQuery()}`, { credentials: "same-origin" });
            if (!res.ok) throw new Error("Failed to load GeoJSON");
            return await res.json();
        }

        function clearLayers() {
            if (clusterLayer) clusterLayer.remove();
            if (heatLayer) heatLayer.remove();
            clusterLayer = null;
            heatLayer = null;
        }

        function renderCluster(data) {
            clusterLayer = L.markerClusterGroup();

            const geo = L.geoJSON(data, {
            pointToLayer: (feature, latlng) => {
                const p = feature.properties || {};
                const color = getColor(p);

                const marker = L.circleMarker(latlng, {
                radius: 7,
                color: color,
                fillColor: color,
                fillOpacity: 0.85,
                weight: 2,
                });

                const url = `${DETAIL_BASE_URL}${p.complaint_id}/`;
                marker.bindPopup(`
                <div style="min-width:240px">
                    <div style="font-weight:800;margin-bottom:4px">${p.title || "Complaint"}</div>
                    <div style="font-size:12px;color:#6B7280">
                    <div><b>ID:</b> #${p.id || ""}</div>
                    <div><b>Status:</b> ${p.status || ""}</div>
                    <div><b>Priority:</b> ${p.priority_level || ""}</div>
                    <div><b>Category:</b> ${p.category || ""}</div>
                    <div><b>Citizen:</b> ${p.citizen || ""}</div>
                    <div style="margin-top:10px">
                        <a href="${url}" style="color:#2563EB;text-decoration:underline;font-weight:600">Open complaint detail</a>
                    </div>
                    </div>
                </div>
                `);

                return marker;
            }
            });

            geo.eachLayer(l => clusterLayer.addLayer(l));
            clusterLayer.addTo(map);

            const bounds = geo.getBounds();
            if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
        }

        function renderHeat(data) {
            const heatPoints = [];
            (data.features || []).forEach(f => {
            const coords = f.geometry?.coordinates;
            if (!coords) return;
            const lng = coords[0];
            const lat = coords[1];
            const p = f.properties || {};
            const intensity = PRIORITY_INTENSITY[p.priority_level] || 0.4;
            heatPoints.push([lat, lng, intensity]);
            });

            heatLayer = L.heatLayer(heatPoints, { radius: 25, blur: 18, maxZoom: 17 }).addTo(map);

            const latlngs = heatPoints.map(h => L.latLng(h[0], h[1]));
            if (latlngs.length) map.fitBounds(L.latLngBounds(latlngs).pad(0.2));
        }

        async function refreshMap() {
            const data = await loadGeoJSON();
            clearLayers();
            if (currentViewMode === "heat") renderHeat(data);
            else renderCluster(data);
        }

        async function initMap() {
            map = L.map("complaintsMap").setView([8.46, -11.78], 12);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19, attribution: "&copy; OpenStreetMap contributors"
            }).addTo(map);

            await refreshMap();

            document.getElementById("colorMode").addEventListener("change", async (e) => {
            currentColorMode = e.target.value;
            await refreshMap();
            });

            document.getElementById("mapViewMode").addEventListener("change", async (e) => {
            currentViewMode = e.target.value;
            await refreshMap();
            });

            ["dateFrom","dateTo","categoryFilter","statusFilter","wardFilter","departmentFilter"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener("change", refreshMap);
            });
        }

        // Charts
        async function fetchJSON(url) {
            const res = await fetch(url, { credentials: "same-origin" });
            if (!res.ok) throw new Error("Failed: " + url);
            return await res.json();
        }

        async function initCharts() {
            const wardData = await fetchJSON("{% url 'admin_agg_ward_counts' %}");
            const catData  = await fetchJSON("{% url 'admin_agg_category_counts' %}");
            const dayData  = await fetchJSON("{% url 'admin_agg_daily_counts' %}");

            new Chart(document.getElementById("wardChart"), {
            type: "bar",
            data: {
                labels: wardData.map(x => x.citizen__ward__name || "Unknown"),
                datasets: [{ label: "Complaints", data: wardData.map(x => x.total), backgroundColor: "#3B82F6" }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
            });

            new Chart(document.getElementById("categoryChart"), {
            type: "doughnut",
            data: {
                labels: catData.map(x => x.category__category_name),
                datasets: [{ data: catData.map(x => x.total) }]
            },
            options: { responsive: true }
            });

            new Chart(document.getElementById("dayChart"), {
            type: "line",
            data: {
                labels: dayData.map(x => x.day),
                datasets: [{
                label: "Complaints/day",
                data: dayData.map(x => x.total),
                borderColor: "#22C55E",
                backgroundColor: "rgba(34,197,94,0.12)",
                fill: true,
                tension: 0.3
                }]
            },
            options: { responsive: true }
            });
        }

        Promise.all([initMap(), initCharts()]).catch(console.error);
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>